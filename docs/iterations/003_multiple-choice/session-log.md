# Сессия: 2026-02-08 — Итерация 003: Multiple Choice

## Цель
Добавить поддержку множественного выбора ответов (checkbox) в модуле тестирования. Фронтенд ранее поддерживал только один правильный ответ (radio), хотя данные в Google Sheets содержат вопросы с несколькими правильными ответами.

## Ключевые промпты и решения

### Промпт 1: Базовая реализация multiple choice
→ Результат: реализована логика `isMultipleChoice()`, checkbox UI, 3-уровневая обратная связь
→ Коммиты: 1fdba73 (fallback-data), 1e84320 (test-module.js + CSS)
→ Проблема: работало только с fallback-данными (офлайн), онлайн — нет

### Промпт 2: Диагностика — почему онлайн не работает
→ Результат: найдена корневая причина — Google Apps Script конвертирует "0,2,3" → 0 через parseInt
→ Цепочка: Sheets ячейка "0,2,3" → Apps Script parseInt → JSON correct: 0 → radio

### Промпт 3: Фикс Google Apps Script
→ Результат: исправлен серверный скрипт — correct отправляется как массив [0,2,3]
→ Также обновлён data-loader.js normalizeQuestions() для обработки обоих форматов

## Что реализовано

### Фронтенд (test-module.js)
- `isMultipleChoice(q)` — определение типа: массив → checkbox, число → radio
- Подсказка: «Выберите все правильные ответы (N)» / «Выберите один ответ»
- Checkbox UI: кнопки-переключатели ☐/☑ с визуальным выделением
- Кнопка «Проверить»: появляется только для multi-choice
- 3-уровневая обратная связь:
  - ✅ «Верно! Все ответы правильные.»
  - ⚠️ «Частично верно. X из Y правильных ответов.»
  - ❌ «Неверно» + подсветка ошибочных
- Single-choice — без изменений (клик = мгновенная проверка)

### Данные (Google Sheets + fallback)
- Обновлена колонка E (Правильный) для 18 вопросов из 81 — вместо одного числа теперь через запятую
- Обновлены fallback-данные в fallback-data.js для всех 18 multi-choice вопросов

### Серверная часть (Google Apps Script)
- Исправлен парсинг колонки E: строка с запятой → массив чисел, одно число → число
- correct: "0,2,3" → [0, 2, 3] вместо 0

### Парсинг на клиенте (data-loader.js)
- normalizeQuestions() обрабатывает оба формата: число и массив

## Принятые решения
- Серверный фикс (Apps Script) вместо клиентского хака по тексту вопроса
- Формат fallback-данных: correct — число (single) или массив (multiple)
- Обратная совместимость: single-choice вопросы работают как прежде

## Баг COMPETENCIES
Проверено: ссылок на `COMPETENCIES` без `_CONFIG` нет. Фикс уже был в коммите 972458f ранее.

## Список multi-choice вопросов (18 из 81)
| Строка | correct |
|--------|---------|
| 6 | [0,1,2,3,4] |
| 7 | [0,2,3] |
| 8 | [0,2,4] |
| 12 | [0,1,4] |
| 14 | [0,2,4] |
| 16 | [0,1,2,4] |
| 18 | [0,2,3] |
| 24 | [0,2,4] |
| 38 | [0,1,2,3,4] |
| 42 | [0,1,3,4] |
| 45 | [0,2,3,4] |
| 51 | [0,1,2,3,4] |
| 54 | [0,2,3] |
| 65 | [0,2,3,4] |
| 68 | [0,1,2,3,4] |
| 75 | [0,1,2] |
| 76 | [0,3] |
| 81 | [0,1,2,3,4] |

## Что не сделано / на потом
- [ ] Проверить все 18 вопросов на продакшне (spot check — вопрос 7 работает)
- [ ] При добавлении новых вопросов через кабинет инструктора (итерация 004) — multiple choice должен поддерживаться из коробки
